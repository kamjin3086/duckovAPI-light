# Modä»£ç é‡æ„è¿ç§»æŒ‡å—

## ğŸ“– ç›®çš„

æœ¬æŒ‡å—å¸®åŠ©ä½ å°†ç°æœ‰çš„Modä»£ç é‡æ„ä¸ºä½¿ç”¨é€šç”¨å·¥å…·ç±»åº“,æé«˜ä»£ç è´¨é‡å’Œå¯ç»´æŠ¤æ€§ã€‚

---

## ğŸ¯ é‡æ„çš„å¥½å¤„

1. **ä»£ç é‡å‡å°‘**: é€šå¸¸å¯ä»¥å‡å°‘30-50%çš„ä»£ç è¡Œæ•°
2. **é€»è¾‘æ›´æ¸…æ™°**: æ ¸å¿ƒä¸šåŠ¡é€»è¾‘å’Œè¾…åŠ©åŠŸèƒ½åˆ†ç¦»
3. **æ˜“äºç»´æŠ¤**: é€šç”¨åŠŸèƒ½ç»Ÿä¸€ç®¡ç†,ä¿®bugåªéœ€æ”¹ä¸€å¤„
4. **å¯å¤ç”¨**: åœ¨å¤šä¸ªModé¡¹ç›®ä¹‹é—´å…±äº«ä»£ç 
5. **æµ‹è¯•æ›´å®¹æ˜“**: ç‹¬ç«‹çš„å·¥å…·ç±»æ›´å®¹æ˜“å•å…ƒæµ‹è¯•

---

## ğŸ“‹ è¿ç§»æ­¥éª¤

### ç¬¬ä¸€æ­¥: å‡†å¤‡å·¥ä½œ

1. **å¤‡ä»½åŸé¡¹ç›®**
   ```bash
   # åˆ›å»ºgitåˆ†æ”¯æˆ–å¤åˆ¶æ•´ä¸ªé¡¹ç›®æ–‡ä»¶å¤¹
   git checkout -b refactor-with-common-utils
   # æˆ–
   cp -r MyMod MyMod_backup
   ```

2. **å¤åˆ¶Commonæ–‡ä»¶å¤¹**
   ```
   å°† duckov_modding/Common/ å¤åˆ¶åˆ°ä½ çš„Modé¡¹ç›®ä¸­
   ```

3. **æ›´æ–°.csprojæ–‡ä»¶**
   ```xml
   <ItemGroup>
     <Compile Include="Common\SceneUtils.cs" />
     <Compile Include="Common\ShaderScanner.cs" />
     <Compile Include="Common\DebugUtils.cs" />
     <Compile Include="Common\AudioUtils.cs" />
   </ItemGroup>
   ```

### ç¬¬äºŒæ­¥: è¯†åˆ«å¯é‡æ„çš„ä»£ç 

æŸ¥æ‰¾ä½ çš„Modä¸­åŒ…å«ä»¥ä¸‹æ¨¡å¼çš„ä»£ç :

#### ğŸ” åœºæ™¯æ£€æŸ¥ç›¸å…³

**åŸä»£ç æ¨¡å¼:**
```csharp
if (LevelManager.Instance == null) return;
var levelInfo = LevelManager.GetCurrentLevelInfo();
string sceneName = levelInfo.sceneName?.ToLower() ?? "";
if (sceneName.Contains("lobby") || sceneName.Contains("menu")) return;
if (levelInfo.isBaseLevel) return;
```

**é‡æ„ä¸º:**
```csharp
using DuckovModding.Common;

if (!SceneUtils.ShouldOperateInCurrentScene(logPrefix: "[MyMod]"))
{
    return;
}
```

---

#### ğŸ” æ‰“å°åœºæ™¯ä¿¡æ¯

**åŸä»£ç æ¨¡å¼:**
```csharp
Debug.Log($"ä¸»åœºæ™¯: {SceneManager.GetActiveScene().name}");
if (LevelManager.Instance != null)
{
    var levelInfo = LevelManager.GetCurrentLevelInfo();
    Debug.Log($"åœºæ™¯åç§°: {levelInfo.sceneName}");
    Debug.Log($"æ˜¯å¦åŸºç¡€å…³å¡: {levelInfo.isBaseLevel}");
    // ... æ›´å¤šä»£ç 
}
if (MultiSceneCore.Instance != null)
{
    Debug.Log($"DisplayName: {MultiSceneCore.Instance.DisplayName}");
    // ... æ›´å¤šä»£ç 
}
```

**é‡æ„ä¸º:**
```csharp
using DuckovModding.Common;

SceneUtils.LogCurrentSceneInfo("OnLevelInitialized", "[MyMod]");
```

---

#### ğŸ” ç©å®¶ä½ç½®æ£€æŸ¥

**åŸä»£ç æ¨¡å¼:**
```csharp
if (CharacterMainControl.Main == null)
{
    Debug.LogWarning("ç©å®¶ä¸å­˜åœ¨");
    return;
}
Vector3 playerPos = CharacterMainControl.Main.transform.position;
```

**é‡æ„ä¸º:**
```csharp
using DuckovModding.Common;

var playerPos = SceneUtils.GetPlayerPosition();
if (!playerPos.HasValue)
{
    Debug.LogWarning("[MyMod] ç©å®¶ä¸å­˜åœ¨");
    return;
}
// ä½¿ç”¨ playerPos.Value
```

---

#### ğŸ” æ‰“å°è°ƒè¯•ä¿¡æ¯

**åŸä»£ç æ¨¡å¼:**
```csharp
Vector3 pos = someObject.transform.position;
Debug.Log($"ä½ç½®: ({pos.x:F2}, {pos.y:F2}, {pos.z:F2})");

Color color = material.color;
Debug.Log($"é¢œè‰²: R:{color.r:F2} G:{color.g:F2} B:{color.b:F2} A:{color.a:F2}");
```

**é‡æ„ä¸º:**
```csharp
using DuckovModding.Common;

Vector3 pos = someObject.transform.position;
Debug.Log($"ä½ç½®: {DebugUtils.FormatVector3(pos, 2)}");

Color color = material.color;
Debug.Log($"é¢œè‰²: {DebugUtils.FormatColor(color, 2)}");
```

---

#### ğŸ” FMODéŸ³é¢‘åŠ è½½

**åŸä»£ç æ¨¡å¼:**
```csharp
FMOD.Studio.System studioSystem = RuntimeManager.StudioSystem;
if (!studioSystem.hasHandle()) { /* error */ }

FMOD.System coreSystem;
FMOD.RESULT result = studioSystem.getCoreSystem(out coreSystem);
if (result != FMOD.RESULT.OK) { /* error */ }

FMOD.Sound sound;
result = coreSystem.createSound(audioPath, FMOD.MODE._3D | FMOD.MODE.LOOP_OFF, out sound);
if (result != FMOD.RESULT.OK) { /* error */ }

// è·å–éŸ³é¢‘ä¿¡æ¯
uint length;
sound.getLength(out length, FMOD.TIMEUNIT.MS);
// ... æ›´å¤šä»£ç 
```

**é‡æ„ä¸º:**
```csharp
using DuckovModding.Common;

string audioPath = AudioUtils.FindAudioFile(modPath);
if (!string.IsNullOrEmpty(audioPath))
{
    FMOD.Sound sound = AudioUtils.LoadAudioWithFMOD(
        audioPath,
        FMOD.MODE.DEFAULT | FMOD.MODE._3D | FMOD.MODE.LOOP_OFF,
        "[MyMod]"
    );
    
    if (sound.hasHandle())
    {
        // éŸ³é¢‘åŠ è½½æˆåŠŸ,å¯ä»¥ä½¿ç”¨
    }
}
```

---

#### ğŸ” Shaderæ‰«æ

**åŸä»£ç æ¨¡å¼:**
```csharp
var allRenderers = UnityEngine.Object.FindObjectsOfType<Renderer>();
Dictionary<string, int> shaderCount = new Dictionary<string, int>();
foreach (var renderer in allRenderers)
{
    if (renderer.sharedMaterials == null) continue;
    foreach (var material in renderer.sharedMaterials)
    {
        if (material == null || material.shader == null) continue;
        string shaderName = material.shader.name;
        if (!shaderCount.ContainsKey(shaderName))
            shaderCount[shaderName] = 0;
        shaderCount[shaderName]++;
    }
}
// ... æ’åºå’Œæ‰“å°
```

**é‡æ„ä¸º:**
```csharp
using DuckovModding.Common;

var shaderInfos = ShaderScanner.ScanSceneShaders("[MyMod]");
// ç»“æœå·²è‡ªåŠ¨æ‰“å°,ä¹Ÿå¯ä»¥è·å–æ•°æ®è¿›è¡Œè¿›ä¸€æ­¥å¤„ç†
```

---

### ç¬¬ä¸‰æ­¥: é€æ­¥é‡æ„

**å»ºè®®é¡ºåº:**

1. **æ·»åŠ usingè¯­å¥**
   ```csharp
   using DuckovModding.Common;
   ```

2. **é‡æ„ç®€å•çš„å·¥å…·æ–¹æ³•**
   - å…ˆé‡æ„ `PrintPlayerPosition()` â†’ `DebugUtils.PrintPlayerPosition()`
   - å†é‡æ„æ ¼å¼åŒ–æ–¹æ³• â†’ `DebugUtils.FormatVector3()`, `FormatColor()`

3. **é‡æ„åœºæ™¯ç›¸å…³é€»è¾‘**
   - `ShouldSpawnInCurrentScene()` â†’ `SceneUtils.ShouldOperateInCurrentScene()`
   - `LogCurrentSceneInfo()` â†’ `SceneUtils.LogCurrentSceneInfo()`

4. **é‡æ„éŸ³é¢‘ç›¸å…³ä»£ç **
   - éŸ³é¢‘åŠ è½½ â†’ `AudioUtils.LoadAudioWithFMOD()`
   - éŸ³é¢‘æ’­æ”¾ â†’ `AudioUtils.Play3DSound()`

5. **é‡æ„Shaderæ‰«æ**
   - `ScanSceneShaders()` â†’ `ShaderScanner.ScanSceneShaders()`
   - `ScanNearbyMaterials()` â†’ `ShaderScanner.ScanNearbyMaterials()`

6. **åˆ é™¤åŸæ–¹æ³•**
   - ç¡®è®¤é‡æ„éƒ¨åˆ†æ­£å¸¸å·¥ä½œå,åˆ é™¤åŸæ¥çš„ç§æœ‰æ–¹æ³•

7. **æµ‹è¯•**
   - ç¼–è¯‘ç¡®è®¤æ²¡æœ‰é”™è¯¯
   - åœ¨æ¸¸æˆä¸­æµ‹è¯•æ‰€æœ‰åŠŸèƒ½

---

## ğŸ“Š é‡æ„å‰åå¯¹æ¯”

### SoundBeacon Modæ¡ˆä¾‹

| æŒ‡æ ‡ | é‡æ„å‰ | é‡æ„å | æ”¹å–„ |
|------|--------|--------|------|
| ä»£ç è¡Œæ•° | 1036è¡Œ | ~400è¡Œ | -61% |
| æ–¹æ³•æ•°é‡ | 28ä¸ª | 15ä¸ª | -46% |
| ç§æœ‰è¾…åŠ©æ–¹æ³• | 18ä¸ª | 5ä¸ª | -72% |
| å¯è¯»æ€§ | ä¸­ | é«˜ | â†‘ |
| å¯ç»´æŠ¤æ€§ | ä¸­ | é«˜ | â†‘ |
| å¯å¤ç”¨æ€§ | ä½ | é«˜ | â†‘ |

### ä»£ç å¯¹æ¯”ç¤ºä¾‹

**é‡æ„å‰ (OnLevelInitializedæ–¹æ³•):**
```csharp
private void OnLevelInitialized()
{
    Debug.Log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    Debug.Log("[SoundBeacon] ğŸ“ å…³å¡å·²åˆå§‹åŒ–");
    LogCurrentSceneInfo("OnLevelInitialized");  // 90è¡Œçš„ç§æœ‰æ–¹æ³•
    Debug.Log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    
    levelInitialized = true;

    if (ShouldSpawnInCurrentScene())  // 60è¡Œçš„ç§æœ‰æ–¹æ³•
    {
        if (isInitialized && spawnedBeacons.Count == 0)
        {
            SpawnBeacons();
        }
    }
    else
    {
        Debug.Log("[SoundBeacon] âš ï¸ å½“å‰åœºæ™¯ä¸é€‚åˆç”Ÿæˆä¿¡æ ‡,è·³è¿‡");
    }
}
```

**é‡æ„å:**
```csharp
private void OnLevelInitialized()
{
    DebugUtils.PrintSeparator("â”", 60);
    Debug.Log($"{LOG_PREFIX} ğŸ“ å…³å¡å·²åˆå§‹åŒ–");
    SceneUtils.LogCurrentSceneInfo("OnLevelInitialized", LOG_PREFIX);
    DebugUtils.PrintSeparator("â”", 60);
    
    levelInitialized = true;

    if (SceneUtils.ShouldOperateInCurrentScene(logPrefix: LOG_PREFIX))
    {
        if (isInitialized && spawnedBeacons.Count == 0)
        {
            SpawnBeacons();
        }
    }
    else
    {
        Debug.Log($"{LOG_PREFIX} âš ï¸ å½“å‰åœºæ™¯ä¸é€‚åˆç”Ÿæˆä¿¡æ ‡,è·³è¿‡");
    }
}
```

**æ”¹è¿›ç‚¹:**
- ä»£ç æ›´ç®€æ´,æ„å›¾æ›´æ˜ç¡®
- ä¸éœ€è¦ç»´æŠ¤150è¡Œçš„ç§æœ‰è¾…åŠ©æ–¹æ³•
- å…¶ä»–Modä¹Ÿèƒ½ä½¿ç”¨è¿™äº›å·¥å…·æ–¹æ³•
- ç»Ÿä¸€çš„LOG_PREFIXç®¡ç†

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. ä¿æŒæ—¥å¿—å‰ç¼€ä¸€è‡´

**æ¨èåšæ³•:**
```csharp
private const string LOG_PREFIX = "[MyModName]";

// åœ¨æ‰€æœ‰å·¥å…·æ–¹æ³•è°ƒç”¨ä¸­ä½¿ç”¨
SceneUtils.LogCurrentSceneInfo("Event", LOG_PREFIX);
DebugUtils.PrintPlayerPosition(LOG_PREFIX);
```

### 2. å¤„ç†å¯ç©ºç±»å‹

å·¥å…·ç±»ä¸­æŸäº›æ–¹æ³•è¿”å›å¯ç©ºç±»å‹,éœ€è¦æ£€æŸ¥:
```csharp
Vector3? playerPos = SceneUtils.GetPlayerPosition();
if (playerPos.HasValue)
{
    // ä½¿ç”¨ playerPos.Value
}
```

### 3. å¼‚å¸¸å¤„ç†

å·¥å…·ç±»å·²åŒ…å«å¼‚å¸¸å¤„ç†,ä½†è°ƒç”¨æ–¹ä¹Ÿåº”è¯¥æœ‰é€‚å½“çš„é”™è¯¯å¤„ç†:
```csharp
try
{
    FMOD.Sound sound = AudioUtils.LoadAudioWithFMOD(path, mode, LOG_PREFIX);
    if (!sound.hasHandle())
    {
        Debug.LogWarning($"{LOG_PREFIX} éŸ³é¢‘åŠ è½½å¤±è´¥");
        // é™çº§å¤„ç†
    }
}
catch (Exception e)
{
    Debug.LogError($"{LOG_PREFIX} å‘ç”Ÿæœªé¢„æœŸé”™è¯¯: {e.Message}");
}
```

### 4. æ€§èƒ½è€ƒè™‘

æŸäº›å·¥å…·æ–¹æ³•æ€§èƒ½å¼€é”€è¾ƒå¤§,ä¸è¦é¢‘ç¹è°ƒç”¨:
```csharp
// âŒ ä¸å¥½ - æ¯å¸§è°ƒç”¨
void Update()
{
    ShaderScanner.ScanSceneShaders();  // å¤ªé¢‘ç¹!
}

// âœ… å¥½ - æŒ‰éœ€è°ƒç”¨
void Update()
{
    if (Input.GetKeyDown(KeyCode.H))
    {
        ShaderScanner.ScanSceneShaders(LOG_PREFIX);
    }
}
```

---

## ğŸ§ª æµ‹è¯•æ¸…å•

é‡æ„å®Œæˆå,ä½¿ç”¨æ­¤æ¸…å•è¿›è¡Œæµ‹è¯•:

- [ ] é¡¹ç›®ç¼–è¯‘æ— é”™è¯¯
- [ ] é¡¹ç›®ç¼–è¯‘æ— è­¦å‘Š(æˆ–å·²çŸ¥è­¦å‘Š)
- [ ] Modåœ¨æ¸¸æˆä¸­å¯ä»¥åŠ è½½
- [ ] æ‰€æœ‰åŸæœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- [ ] å¿«æ·é”®åŠŸèƒ½æ­£å¸¸
- [ ] æ—¥å¿—è¾“å‡ºæ­£ç¡®ä¸”æ ¼å¼ç»Ÿä¸€
- [ ] åœºæ™¯åˆ‡æ¢æ—¶ä¸æŠ¥é”™
- [ ] èµ„æºæ­£ç¡®é‡Šæ”¾(OnDestroyæµ‹è¯•)
- [ ] æ€§èƒ½æ— æ˜æ˜¾ä¸‹é™

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [Commonå·¥å…·ç±»åº“README](./README.md)
- [SoundBeaconé‡æ„ç‰ˆç¤ºä¾‹](../SoundBeacon/ModBehaviour_Refactored.cs)
- [Shaderæ‰«æä½¿ç”¨è¯´æ˜](../SoundBeacon/Shaderæ‰«æä½¿ç”¨è¯´æ˜.md)

---

## ğŸ’¡ æœ€ä½³å®è·µ

1. **å°æ­¥å¿«è·‘**: ä¸€æ¬¡é‡æ„ä¸€å°éƒ¨åˆ†,ç¡®ä¿æ¯æ­¥éƒ½èƒ½ç¼–è¯‘é€šè¿‡
2. **ä¿ç•™å¤‡ä»½**: é‡æ„å‰åˆ›å»ºgitåˆ†æ”¯æˆ–æ–‡ä»¶å‰¯æœ¬
3. **æµ‹è¯•é©±åŠ¨**: é‡æ„ä¸€éƒ¨åˆ†å°±æµ‹è¯•ä¸€éƒ¨åˆ†
4. **ç»Ÿä¸€é£æ ¼**: ä½¿ç”¨ç»Ÿä¸€çš„æ—¥å¿—å‰ç¼€å’Œæ ¼å¼åŒ–æ–¹å¼
5. **æ–‡æ¡£åŒæ­¥**: æ›´æ–°Modçš„README,è¯´æ˜ä½¿ç”¨äº†é€šç”¨å·¥å…·ç±»

---

## ğŸ¤ éœ€è¦å¸®åŠ©?

å¦‚æœåœ¨é‡æ„è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜:

1. æŸ¥çœ‹ `ModBehaviour_Refactored.cs` å®Œæ•´ç¤ºä¾‹
2. é˜…è¯»å„å·¥å…·ç±»çš„æºä»£ç æ³¨é‡Š
3. åœ¨ç¤¾åŒºè®ºå›æé—®
4. æŸ¥çœ‹å…¶ä»–ä½¿ç”¨é€šç”¨åº“çš„Modé¡¹ç›®

---

**ç¥é‡æ„é¡ºåˆ©! ğŸ‰**

