# DuckovModding é€šç”¨å·¥å…·ç±»åº“ - å¿«é€Ÿå¼€å§‹æŒ‡å—

## ğŸš€ 5åˆ†é’Ÿå¿«é€Ÿä¸Šæ‰‹

### ç¬¬1æ­¥: å¤åˆ¶Commonæ–‡ä»¶å¤¹

å°† `duckov_modding/Common/` æ–‡ä»¶å¤¹å¤åˆ¶åˆ°ä½ çš„Modé¡¹ç›®çš„ä¸Šçº§ç›®å½•:

```
ä½ çš„é¡¹ç›®/
â”œâ”€â”€ Common/          â† å¤åˆ¶åˆ°è¿™é‡Œ
â”‚   â”œâ”€â”€ SceneUtils.cs
â”‚   â”œâ”€â”€ ShaderScanner.cs
â”‚   â””â”€â”€ ...
â””â”€â”€ YourMod/
    â”œâ”€â”€ ModBehaviour.cs
    â””â”€â”€ YourMod.csproj
```

---

### ç¬¬2æ­¥: æ›´æ–°.csprojæ–‡ä»¶

åœ¨ä½ çš„ `.csproj` æ–‡ä»¶ä¸­æ·»åŠ é€šç”¨å·¥å…·ç±»å¼•ç”¨:

```xml
<Project Sdk="Microsoft.NET.Sdk">
  <!-- ç°æœ‰çš„PropertyGroupå’ŒReferenceä¿æŒä¸å˜ -->
  
  <!-- åœ¨æœ€åæ·»åŠ é€šç”¨å·¥å…·ç±»åº“ -->
  <ItemGroup>
    <!-- æ ¹æ®éœ€è¦é€‰æ‹©å·¥å…·ç±» -->
    <Compile Include="..\Common\SceneUtils.cs" Link="Common\SceneUtils.cs" />
    <Compile Include="..\Common\DebugUtils.cs" Link="Common\DebugUtils.cs" />
    <Compile Include="..\Common\HarmonyUtils.cs" Link="Common\HarmonyUtils.cs" />
    <Compile Include="..\Common\UIUtils.cs" Link="Common\UIUtils.cs" />
    <Compile Include="..\Common\ComponentUtils.cs" Link="Common\ComponentUtils.cs" />
    <!-- å…¶ä»–å·¥å…·ç±»... -->
  </ItemGroup>
</Project>
```

---

### ç¬¬3æ­¥: åœ¨ä»£ç ä¸­ä½¿ç”¨

åœ¨ä½ çš„ `ModBehaviour.cs` æ–‡ä»¶é¡¶éƒ¨æ·»åŠ :

```csharp
using DuckovModding.Common;
```

ç„¶åå°±å¯ä»¥ä½¿ç”¨å„ç§å·¥å…·æ–¹æ³•äº†ï¼

---

## ğŸ“š å¸¸ç”¨åœºæ™¯é€ŸæŸ¥

### ğŸ¯ åœºæ™¯1: åˆå§‹åŒ–Mod (ä½¿ç”¨Harmony)

```csharp
using DuckovModding.Common;
using HarmonyLib;

private Harmony harmony;
private const string LOG_PREFIX = "[MyMod]";

void Awake()
{
    // ä¸€è¡Œä»£ç å®ŒæˆHarmonyåˆå§‹åŒ–å’ŒéªŒè¯
    harmony = HarmonyUtils.InitializeAndPatch(
        "com.mymod.modname",
        typeof(ModBehaviour).Assembly,
        LOG_PREFIX
    );
    
    // åˆ›å»ºæŒä¹…åŒ–å¯¹è±¡
    var manager = ComponentUtils.CreatePersistentObject<MyManager>("MyManager");
    
    DebugUtils.PrintBoxedLog("åˆå§‹åŒ–å®Œæˆ", "Modå·²æˆåŠŸåŠ è½½", LOG_PREFIX);
}

void OnDestroy()
{
    HarmonyUtils.UnpatchAll(harmony, "com.mymod.modname", LOG_PREFIX);
}
```

---

### ğŸ¯ åœºæ™¯2: æ£€æŸ¥åœºæ™¯å¹¶æ‰§è¡Œæ“ä½œ

```csharp
private void OnLevelInitialized()
{
    // æ‰“å°åœºæ™¯ä¿¡æ¯(è°ƒè¯•æ—¶ä½¿ç”¨)
    SceneUtils.LogCurrentSceneInfo("OnLevelInitialized", "[MyMod]");
    
    // æ£€æŸ¥æ˜¯å¦åº”è¯¥åœ¨å½“å‰åœºæ™¯æ‰§è¡Œæ“ä½œ(æ’é™¤å¤§å…ã€èœå•ç­‰)
    if (!SceneUtils.ShouldOperateInCurrentScene(logPrefix: "[MyMod]"))
    {
        Debug.Log("[MyMod] å½“å‰åœºæ™¯ä¸é€‚åˆæ‰§è¡Œæ“ä½œï¼Œè·³è¿‡");
        return;
    }
    
    // è·å–ç©å®¶ä½ç½®
    Vector3? playerPos = SceneUtils.GetPlayerPosition();
    if (playerPos.HasValue)
    {
        Debug.Log($"[MyMod] ç©å®¶ä½ç½®: {DebugUtils.FormatVector3(playerPos.Value)}");
        SpawnSomething(playerPos.Value);
    }
}
```

---

### ğŸ¯ åœºæ™¯3: åˆ›å»ºUI

```csharp
private Canvas myCanvas;
private Button myButton;

void CreateUI()
{
    // åˆ›å»ºCanvas
    myCanvas = UIUtils.CreateCanvas("MyModCanvas", sortingOrder: 1000);
    
    // åˆ›å»ºæŒ‰é’®
    myButton = UIUtils.CreateButton(
        myCanvas.transform,
        "MyButton",
        "ç‚¹å‡»æˆ‘",
        onClick: OnButtonClicked,
        size: new Vector2(200f, 50f)
    );
    
    // å±…ä¸­æŒ‰é’®
    UIUtils.SetCenter(myButton.GetComponent<RectTransform>(), new Vector2(200f, 50f));
    
    // åˆ›å»ºæ–‡æœ¬
    var text = UIUtils.CreateText(
        myCanvas.transform,
        "TitleText",
        "æˆ‘çš„Mod",
        fontSize: 24f,
        color: Color.yellow
    );
}

void OnButtonClicked()
{
    Debug.Log("[MyMod] æŒ‰é’®è¢«ç‚¹å‡»!");
}
```

---

### ğŸ¯ åœºæ™¯4: ä¿å­˜å’ŒåŠ è½½è®¾ç½®

```csharp
// æ–¹å¼1: ç›´æ¥ä½¿ç”¨
void SaveSettings()
{
    SettingsUtils.SaveInt("MyMod_Volume", 80, "[MyMod]");
    SettingsUtils.SaveBool("MyMod_Enabled", true, "[MyMod]");
}

void LoadSettings()
{
    int volume = SettingsUtils.LoadInt("MyMod_Volume", 100, "[MyMod]");
    bool enabled = SettingsUtils.LoadBool("MyMod_Enabled", true, "[MyMod]");
}

// æ–¹å¼2: ä½¿ç”¨Modç®¡ç†å™¨ (æ¨è)
private SettingsUtils.ModSettingsManager settings;

void Awake()
{
    settings = new SettingsUtils.ModSettingsManager("MyMod", "[MyMod]");
    LoadSettings();
}

void LoadSettings()
{
    int volume = settings.LoadInt("Volume", 100);
    bool enabled = settings.LoadBool("Enabled", true);
}

void SaveSettings()
{
    settings.SaveInt("Volume", 80);
    settings.SaveBool("Enabled", true);
}
```

---

### ğŸ¯ åœºæ™¯5: åŠ è½½FMODéŸ³é¢‘

```csharp
private FMOD.Sound mySound;

void Start()
{
    // æŸ¥æ‰¾éŸ³é¢‘æ–‡ä»¶
    string modPath = Path.GetDirectoryName(GetType().Assembly.Location);
    string audioPath = AudioUtils.FindAudioFile(modPath);
    
    if (!string.IsNullOrEmpty(audioPath))
    {
        // åŠ è½½éŸ³é¢‘
        mySound = AudioUtils.LoadAudioWithFMOD(
            audioPath,
            FMOD.MODE.DEFAULT | FMOD.MODE._3D | FMOD.MODE.LOOP_OFF,
            "[MyMod]"
        );
        
        if (mySound.hasHandle())
        {
            Debug.Log("[MyMod] éŸ³é¢‘åŠ è½½æˆåŠŸ");
        }
    }
}

void PlaySoundAtPosition(Vector3 position)
{
    // æ’­æ”¾3DéŸ³é¢‘
    FMOD.Channel channel = AudioUtils.Play3DSound(
        mySound,
        position,
        volume: 0.8f,
        minDistance: 5f,
        maxDistance: 50f,
        "[MyMod]"
    );
}

void OnDestroy()
{
    AudioUtils.ReleaseSound(ref mySound, "[MyMod]");
}
```

---

### ğŸ¯ åœºæ™¯6: æ‰«æåœºæ™¯Shader (å¼€å‘3Dæ¨¡å‹æ—¶)

```csharp
void Update()
{
    // æŒ‰Hé”®æ‰«æåœºæ™¯ä¸­çš„Shader
    if (Input.GetKeyDown(KeyCode.H))
    {
        ShaderScanner.ScanSceneShaders("[MyMod]");
    }
    
    // æŒ‰Jé”®æ‰«æé™„è¿‘ç‰©ä½“æè´¨
    if (Input.GetKeyDown(KeyCode.J))
    {
        var playerPos = SceneUtils.GetPlayerPosition();
        if (playerPos.HasValue)
        {
            ShaderScanner.ScanNearbyMaterials(playerPos.Value, 20f, 15, "[MyMod]");
        }
    }
}
```

---

### ğŸ¯ åœºæ™¯7: æ£€æµ‹é¼ æ ‡æ˜¯å¦åœ¨ç©ºç™½åŒºåŸŸ

```csharp
private Canvas myCanvas;

void Update()
{
    // æ£€æŸ¥é¼ æ ‡æ˜¯å¦åœ¨ç©ºç™½åŒºåŸŸ(æ’é™¤è‡ªå·±çš„UI)
    if (UIUtils.IsMouseOverEmptyArea(myCanvas.gameObject))
    {
        Debug.Log("[MyMod] é¼ æ ‡åœ¨ç©ºç™½åŒºåŸŸ");
        
        // ä¾‹å¦‚: ç‚¹å‡»ç©ºç™½åŒºåŸŸå…³é—­UI
        if (Input.GetMouseButtonDown(0))
        {
            myCanvas.gameObject.SetActive(false);
        }
    }
}
```

---

### ğŸ¯ åœºæ™¯8: ç»„ä»¶ç®¡ç†å’Œå»¶è¿Ÿè°ƒç”¨

```csharp
void Start()
{
    // å®‰å…¨è·å–æˆ–æ·»åŠ ç»„ä»¶
    var audioSource = ComponentUtils.GetOrAddComponent<AudioSource>(gameObject);
    
    // ä¸‹ä¸€å¸§æ‰§è¡Œ
    ComponentUtils.NextFrameCall(this, () => {
        Debug.Log("[MyMod] ä¸‹ä¸€å¸§æ‰§è¡Œ");
        InitializeAfterFrame();
    });
    
    // å»¶è¿Ÿ2ç§’æ‰§è¡Œ
    ComponentUtils.DelayedCall(this, 2f, () => {
        Debug.Log("[MyMod] 2ç§’åæ‰§è¡Œ");
        SpawnEnemies();
    });
}

// ä½¿ç”¨æ ‡è®°ç³»ç»Ÿé¿å…é‡å¤å¤„ç†
void ProcessObject(GameObject obj)
{
    // æ£€æŸ¥æ˜¯å¦å·²å¤„ç†è¿‡
    if (ComponentUtils.HasMarker<MyProcessedMarker>(obj))
    {
        return; // å·²å¤„ç†è¿‡ï¼Œè·³è¿‡
    }
    
    // å¤„ç†å¯¹è±¡
    DoSomething(obj);
    
    // æ·»åŠ æ ‡è®°
    ComponentUtils.AddMarker<MyProcessedMarker>(obj);
}

// æ ‡è®°ç»„ä»¶(ç©ºç±»å³å¯)
public class MyProcessedMarker : MonoBehaviour { }
```

---

## ğŸ“– å®Œæ•´APIå‚è€ƒ

æŸ¥çœ‹ [README.md](./README.md) è·å–å®Œæ•´çš„APIæ–‡æ¡£å’Œè¯¦ç»†è¯´æ˜ã€‚

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. ç»Ÿä¸€ä½¿ç”¨æ—¥å¿—å‰ç¼€

```csharp
private const string LOG_PREFIX = "[MyMod]";

// åœ¨æ‰€æœ‰å·¥å…·ç±»è°ƒç”¨ä¸­ä½¿ç”¨
SceneUtils.LogCurrentSceneInfo("Event", LOG_PREFIX);
DebugUtils.PrintPlayerPosition(LOG_PREFIX);
```

### 2. ä½¿ç”¨è®¾ç½®ç®¡ç†å™¨

```csharp
// åœ¨Awakeä¸­åˆå§‹åŒ–ä¸€æ¬¡
private SettingsUtils.ModSettingsManager settings;

void Awake()
{
    settings = new SettingsUtils.ModSettingsManager("MyMod", "[MyMod]");
}

// ç„¶ååœ¨ä»»ä½•åœ°æ–¹ä½¿ç”¨
void SaveVolume(int value)
{
    settings.SaveInt("Volume", value);
}
```

### 3. æ­£ç¡®å¤„ç†å¯ç©ºç±»å‹

```csharp
// å·¥å…·ç±»è¿”å›å¯ç©ºç±»å‹æ—¶ï¼Œè¦æ£€æŸ¥
Vector3? playerPos = SceneUtils.GetPlayerPosition();
if (playerPos.HasValue)
{
    UsePosition(playerPos.Value);
}
else
{
    Debug.LogWarning("[MyMod] ç©å®¶ä¸å­˜åœ¨");
}
```

### 4. æ€§èƒ½è€ƒè™‘

```csharp
// âŒ ä¸å¥½ - æ¯å¸§æ‰«æ
void Update()
{
    ShaderScanner.ScanSceneShaders();  // å¤ªé¢‘ç¹!
}

// âœ… å¥½ - æŒ‰éœ€è°ƒç”¨
void Update()
{
    if (Input.GetKeyDown(KeyCode.H))
    {
        ShaderScanner.ScanSceneShaders("[MyMod]");
    }
}
```

---

## ğŸ” ç¤ºä¾‹é¡¹ç›®

æŸ¥çœ‹ä»¥ä¸‹é‡æ„ç¤ºä¾‹äº†è§£æ›´å¤š:

- `SoundBeacon/ModBehaviour_Refactored.cs` - å®Œæ•´çš„é‡æ„ç¤ºä¾‹
- `ItemDropOnDrag/ModBehaviour_Refactored.cs` - Harmonyå’ŒUIä½¿ç”¨
- `UIScaleAdjuster/ModBehaviour_Refactored.cs` - è®¾ç½®ç®¡ç†ç¤ºä¾‹

---

## â“ å¸¸è§é—®é¢˜

### Q: æˆ‘åªéœ€è¦éƒ¨åˆ†å·¥å…·ç±»ï¼Œæ€ä¹ˆåŠï¼Ÿ

A: åœ¨ `.csproj` ä¸­åªå¼•ç”¨ä½ éœ€è¦çš„å·¥å…·ç±»å³å¯:

```xml
<ItemGroup>
  <!-- åªå¼•ç”¨éœ€è¦çš„ -->
  <Compile Include="..\Common\DebugUtils.cs" Link="Common\DebugUtils.cs" />
  <Compile Include="..\Common\SceneUtils.cs" Link="Common\SceneUtils.cs" />
</ItemGroup>
```

### Q: å·¥å…·ç±»å’Œæˆ‘çš„ä»£ç æœ‰å‘½åå†²çªï¼Ÿ

A: ä½¿ç”¨åˆ«å:

```csharp
using ModDebug = DuckovModding.Common.DebugUtils;

// è°ƒç”¨æ—¶ä½¿ç”¨åˆ«å
ModDebug.PrintPlayerPosition("[MyMod]");
```

### Q: å¦‚ä½•è°ƒè¯•å·¥å…·ç±»ï¼Ÿ

A: å·¥å…·ç±»çš„æºä»£ç å°±åœ¨Commonæ–‡ä»¶å¤¹ä¸­ï¼Œå¯ä»¥ç›´æ¥ä¿®æ”¹å’Œè°ƒè¯•ã€‚

### Q: å·¥å…·ç±»ä¼šå½±å“æ€§èƒ½å—ï¼Ÿ

A: ä¸ä¼šã€‚é™¤äº† `ShaderScanner` çš„æ‰«ææ–¹æ³•å¤–ï¼Œå…¶ä»–å·¥å…·æ–¹æ³•æ€§èƒ½å¼€é”€éƒ½å¾ˆå°ã€‚

---

## ğŸ“š æ›´å¤šèµ„æº

- [å®Œæ•´APIæ–‡æ¡£](./README.md)
- [è¿ç§»æŒ‡å—](./è¿ç§»æŒ‡å—.md) - å¦‚ä½•é‡æ„ç°æœ‰Mod
- [æå–æ€»ç»“](./é€šç”¨å·¥å…·ç±»åº“æå–æ€»ç»“.md) - å·¥å…·ç±»çš„è®¾è®¡æ€è·¯

---

**ç¥ä½ Modå¼€å‘æ„‰å¿«! ğŸ®**

